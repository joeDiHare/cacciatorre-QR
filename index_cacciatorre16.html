<!DOCTYPE html>
<meta charset="utf-8">
<h1>CacciaTorre 2016</h1>
<!-- <p><i>switcher</i></p> -->
<div class="info_clue">
  <div id="loc_div"></div>
  <div id="team_div"></div>
</div>
<div class="container_clue">
  <div id="clue"></div>
</div>
<!--  Add aiuti-->
<div id=help-container class=help-container>
  <!-- <h3>Serv na man?</h3> -->
    <button id="btn_helpme_id"  class='btn'>AIUTINO -10 punti</button>
    <button id="btn_solution_id" class='btn'>SOLUTION -20 punti</button>
</div>
<!-- The Modal for Helpme-->
<div id="myModalHelpme" class="modal">
  <!-- Modal content -->
  <div class="modal-content">
    <div class="modal-header">
      <span class="close">×</span>
      <h2>Aiuto: HELP ME</h2>
    </div>
    <div id="modalHelpme-body" class="modal-body">
      <p>help</p>
    </div>
    <div class="modal-footer">
      <h3>10 punti verranno sottratti per questo aiuto alla fine della caccia.</h3>
    </div>
  </div>
</div>
<!-- The Modal for Solution -->
<div id="btns_aiuti_id" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <span class="close">×</span>
      <h2>Aiuto: SOLUTION</h2>
    </div>
    <div id="modalSolution-body" class="modal-body">
      <p>solution</p>
    </div>
    <div class="modal-footer">
      <h3>Un totale di 20 punti verranno sottratti per questo indizio alla fine della caccia.</h3>
    </div>
  </div>
</div>
<!-- <p>Leaderboard</p> -->
<div id="chart-container"></div>
<!-- <p>remaning time:</p> -->
<div id="clockdiv">
  <div>
    <span class="hours"></span>
    <div class="smalltext">&nbsp;&nbsp;&nbsp;Hours&nbsp;&nbsp;&nbsp;</div>
  </div>
  <div>
    <span class="minutes"></span>
    <div class="smalltext">&nbsp;Minutes&nbsp;</div>
  </div>
  <div>
    <span class="seconds"></span>
    <div class="smalltext">&nbsp;Seconds&nbsp;</div>
  </div>
</div>


<!--  STYLE  -->
<style>
.info_clue{
    font-size: 15px;
    margin-top: 8px;
    color: #A9A9A9;
  }
.container_clue{
      font-size: 58px;
      margin-top: 55px;
      margin-bottom: 55px;
    }
.plotToolText{
  font-size: 14px;
  letter-spacing: 1px;
}
#chart-container{
  margin-top: 80px;
}
/* The Modal (background) */
.modal {
    display: none; /* Hidden by default */
    position: fixed; /* Stay in place */
    z-index: 1; /* Sit on top */
    padding-top: 100px; /* Location of the box */
    left: 0;
    top: 0;
    width: 100%; /* Full width */
    height: 100%; /* Full height */
    overflow: auto; /* Enable scroll if needed */
    background-color: rgb(0,0,0); /* Fallback color */
    background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
}
/* Modal Content */
.modal-content {
    position: relative;
    background-color: #fefefe;
    margin: auto;
    padding: 0;
    border: 1px solid #888;
    width: 80%;
    box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
    -webkit-animation-name: animatetop;
    -webkit-animation-duration: 0.4s;
    animation-name: animatetop;
    animation-duration: 0.4s
}
/* Add Animation */
@-webkit-keyframes animatetop {
    from {top:-300px; opacity:0}
    to {top:0; opacity:1}
}
@keyframes animatetop {
    from {top:-300px; opacity:0}
    to {top:0; opacity:1}
}
/* The Close Button */
.close {
    color: white;
    float: right;
    font-size: 48px;
    font-weight: bold;
}
.btn {
	background-color:#2AA992;//#44c767;
	-moz-border-radius:26px;
	-webkit-border-radius:26px;
	border-radius:26px;
	border:1px solid #18ab29;
	display:inline-block;
	cursor:pointer;
	color:#ffffff;
	font-family:Arial;
	font-size:22px;
	padding:12px 25px;
	text-decoration:none;
	text-shadow:0px 1px 0px #2f6627;
  float: center;
}
.btn:hover {
	background-color:#000;
}
.btn:active {
	position:relative;
	top:1px;
}
.help-container{
  display: none; /* Hidden by default */
  margin-top: 60px;
  float: center;
}
.close:hover,
.close:focus {
    color: #000;
    text-decoration: none;
    cursor: pointer;
}
.modal-header {
    padding: 2px 16px;
    background-color: #5cb85c;
    color: white;
}
.modal-body {
  padding: 2px 16px;
  font-size: 40px;
}
.modal-footer {
    padding: 2px 16px;
    background-color: #5cb85c;
    color: white;
}
body{
  font-family: sans-serif;
  text-align: center;
}
h1{
  color: #396;
  font-weight: 100;
  font-size: 45px;
  margin: 40px 0px 20px;
  text-align: center;
  /*background: #00ECB9;*/
  font-family: sans-serif;
}
#clockdiv{
    font-family: sans-serif;
    color: #fff;
    display: inline-block;
    font-weight: 100;
    text-align: center;
    font-size: 50px;
    display: none; /* Hidden by default */
    margin-top: 40px;
}
#clockdiv > div{
    padding: 10px;
    border-radius: 3px;
    background: #00BF96;
    display: inline-block;
}
#clockdiv div > span{
    padding: 15px;
    border-radius: 3px;
    background: #00816A;
    display: inline-block;
}
.smalltext{
    padding-top: 5px;
    font-size: 28px;
}
.team-div{
  text-align: left;
  font-size: 28px;
}
.loc-div {
  text-align: right;
  font-size: 28px;
}
</style>

<script type="text/javascript" src="https://code.jquery.com/jquery-1.12.0.min.js"></script>
<!-- <script src="https://code.jquery.com/jquery-3.0.0-alpha1.js"></script> -->
<script src="http://static.fusioncharts.com/code/latest/fusioncharts.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDkf003a1BHS3n1pjBGU7Vt-NPtX8bOS9U"></script>
<!-- <script src="https://www.googleapis.com/geolocation/v1/geolocate?key=AIzaSyC3lqec8rY4P221IG6LF5skEiyP9j1L_C4"></script> -->
<script src="fetchData.js"           type="text/javascript"></script>
<script src="getQueryStringArray.js" type="text/javascript"></script>
<script src="adjustColumn.js"        type="text/javascript"></script>
<script src="notifyUseOfHelp.js"     type="text/javascript"></script>
<script src="getTimeRemaining.js"    type="text/javascript"></script>
<script src="initializeClock.js"     type="text/javascript"></script>
<script src="findClueMatch.js"       type="text/javascript"></script>
<script src="updateSheet.js"         type="text/javascript"></script>
<script src="updateLog.js"           type="text/javascript"></script>
<script src="makeChart.js"           type="text/javascript"></script>

<script type="text/javascript">
// if (navigator.geolocation) {
//     navigator.geolocation.getCurrentPosition(function(position){
//     var latitude  = position.coords.latitude;
//     var longitude = position.coords.longitude;
//     var accuracy  = position.coords.accuracy;
//     },function error(msg){alert('Please enable your GPS position future.');
//   }, {maximumAge:600000, timeout:5000, enableHighAccuracy: true});
// }else {
//     alert("Geolocation API is not supported in your browser.");
// }
</script>

<script>
// Ask for team's password
// var team_psw = prompt("Cacciatorre 2016 \nImmetti la password della tua squadra:", "");
team_psw='qzmo'
// console.log('password inputted: ' + team_psw)

// FETCH DATA
var all_matches = fetchData()

// POPULATE CLUE IN HTML ~~ ~~ ~~ ~~ ~~ ~~ ~~ ~~ ~~ ~~ ~~
var qs = getQueryStringArray();
var url_next_ind = '';
match_results = undefined;
if (qs.ind !== 'undefined' && qs.ind) { match_results = findClueMatch(qs.ind, team_psw); }

var timeout_chart = 100;
if (match_results !== 'undefined' && match_results){
  // check that previous clue has been completed
  var sheetsuUrl = "https://sheetsu.com/apis/v1.0/0c52c1f265dc";
  var API_KEY    = 'vVMy5ukvxGRu6jrvpC5A';
  var API_SECRET = 'EHcLf9fxyyy7iqCW63yEpBxqpNtwtMmYhnDRkTAF';
  var prev_clue_completed = true;
  $.ajax({
    // url: sheetsuUrl + searchQuery,
    url: sheetsuUrl + '/team_name/' + match_results[2],
    // headers: {"Authorization": "Basic " + btoa(API_KEY + ":" + API_SECRET)},
    dataType: 'json',
    type: 'GET',
    success: function(data) { //wait for a response before continuing
      prev_clue_completed = '1'==data[0]["indizio_"+(parseInt(match_results[6])-1).toString()];
      if (prev_clue_completed) {

        // UPDATE SPREADSHEET ~~ ~~ ~~ ~~ ~~ ~~ ~~ ~~ ~~ ~~ ~~
        updateSheet('1');

        document.getElementById('loc_div').innerHTML =match_results[3];//'Posizione Attuale: '+
        document.getElementById('team_div').innerHTML=match_results[2];//'Team: '+
        document.getElementById('clue').innerHTML=adjustColumn(match_results[9]);

        // make AIUTI buttons visible and implement logic
        var modalHelpme = document.getElementById('myModalHelpme'); // Get the modal
        var btn_helpme = document.getElementById("btn_helpme_id"); // Get the button that opens the modal
        var span = document.getElementsByClassName("close")[0]; // Get the <span> element that closes the modal
        btn_helpme.onclick = function() {
          modalHelpme.style.display = "block";
          btn_helpme.style.backgroundColor = "#000"
          document.getElementById("modalHelpme-body").innerHTML =
                         '<br />'+adjustColumn(match_results[10])+'<br />';
          notifyUseOfHelp('HelpMe');
          }
        span.onclick = function() { modalHelpme.style.display = "none"; }// When the user clicks on <span> (x), close the modal
        window.onclick = function(event) { if (event.target == modalHelpme) { modalHelpme.style.display = "none";} }
        // repeat for other button ('solution')
        var modalSolution = document.getElementById('btns_aiuti_id');
        var btn_solution = document.getElementById("btn_solution_id");
        var span2 = document.getElementsByClassName("close")[1];
        btn_solution.onclick = function() {
          modalSolution.style.display = "block";
          btn_solution.style.backgroundColor = "#000"
          document.getElementById("modalSolution-body").innerHTML =
                          '<br />'+match_results[3]+'<br />';
          notifyUseOfHelp('Solution');
          }
        span2.onclick = function() { modalSolution.style.display = "none"; }
        window.onclick = function(event) {if (event.target == modalSolution) { modalSolution.style.display = "none";}}
        // make buttons visible
        var help_container = document.getElementById('help-container');
        help_container.style.display = "block";
        updateLog(0,0,1,0,0); // log: solved

      } else {
        document.getElementById('clue').innerHTML="POSTO SBAGLIATO! <br /> Questo luogo   non e' la soluzione all'indovinello precedente.";
        updateLog(0,0,0,1,0); // log: incorrect_place

      }

      makeChart();
      // make timeout clock visible after charts
      setTimeout(function() { clockdiv.style.display = "block"; }, timeout_chart+300);
      },
    error:   function(data) {
      document.getElementById('clue').innerHTML="Password non riconosciuta."+ "<br />" + "<a href='javascript:window.location.href=window.location.href'>Riprovare</a>.";
      updateLog(0,0,0,0,1); // log: incorrect_place

      console.log('error: '+data);
      } // handling error response
  });
}else{
    document.getElementById('clue').innerHTML="Password non riconosciuta."+ "<br />" + "<a href='javascript:window.location.href=window.location.href'>Riprovare</a>.";
    makeChart();
    // make timeout clock visible after charts
    setTimeout(function() { clockdiv.style.display = "block"; }, timeout_chart+300);
 }
</script>
